
<!DOCTYPE HTML>

<html>
	<head>
    <title>Ember CSI</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <link rel="stylesheet" href="/assets/css/main.css" />
    
    <meta name="generator" content="Hugo 0.45.1" />
    <link href="https://fonts.googleapis.com/css?family=Pattaya" rel="stylesheet">
<link rel="icon" type="image/svg+xml" href="/images/ember.svg">
<link rel="icon" href="/images/icon192.png">

</head>

	<body class="homepage">
		<div id="page-wrapper">

			
			<div id="header-wrapper">
				<div id="header">

                    <section id="top_page">
					
<div>
<h1><a href="/"><img src="/images/ember.svg" height=64/> EMBER</a></h1>
<h2>Unified Storage Plugin for Containers</h2>
</div>

					
<div>
<nav id="nav">
    <ul>
            <li><a href="https://twitter.com/ember-csi"><i class="fa fa-twitter"></i></a></li>
            <li><a href='https://kiwiirc.com/client/irc.freenode.net/ember-csi'><i class="fa fa-hashtag"></i></a></li>
            <li><a href='https://github.com/akrog/ember-csi'><i class="fa fa-github"></i></a></li>
            <li><a href='http://docs.ember-csi.io'><i class="fa fa-book"></i></a></li>
    </ul>
</nav>
</div>

                    </section>

				</div>
			</div>

			
			<div id="main-wrapper">
				<div class="container">
					
					
<article class="box post">
    <a href="#" class="image featured"><img src="/images/01-getstarted.jpg" alt="" /></a>
    <header>
        <h2>Kubernetes and Ember CSI</h2>
        
    </header>
    

<p>Many things need to be considered when deploying a CSI plugin in Kubernetes, making it a painful experience for many first time users.  To ease this first contact with Kubernetes and CSI, the Ember repository comes with a <a href="https://github.com/Akrog/ember-csi/tree/master/examples/kubernetes">Kubernetes example that automates the deployment of Kubernetes with Ember CSI</a>.</p>

<p>This article covers how to run the demo to deploy a Kubernetes single master cluster on CentOS 7 with 2 additional nodes using <a href="http://kubernetes.io/docs/admin/kubeadm/">kubeadm</a> and Ember-CSI as the storage provider with an LVM loopback device as the backend.</p>

<p>Ember CSI plugin is set as the default storage class, running 1 service (<code>StatefulSet</code>) with the CSI plugin running as <em>Controller</em> to manage the provisioning on <em>node0</em>, and a service (<code>DaemonSet</code>) running the plugin as <em>Node</em> mode on each of the nodes to manage local attachments.</p>

<p>Specific Kubernetes configuration changes are carried out by the demo&rsquo;s Ansible playbook, and won&rsquo;t be covered in this article.</p>

<h3 id="requirements">Requirements</h3>

<p>The automated script relies on Vagrant, libvirt, KVM, and Ansible for the creation and provisioning of the 3 VMs. So we&rsquo;ll need to have the required packages.</p>

<p>In fedora these packages can be installed with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo dnf -y install qemu-kvm libvirt vagrant-libvirt ansible</code></pre></div>
<h3 id="configuration">Configuration</h3>

<p>The demo doesn&rsquo;t require any configuration changes to run, and the <code>Vagranfile</code> defines 2 nodes and a master, each with 4GB and 2 cores.  Which can be changed using variables <code>NODES</code>, <code>MEMORY</code>, and <code>CPUS</code> in the file.</p>

<h3 id="setup">Setup</h3>

<p>The demo supports local and remote libvirt, for those that use an external box to run their VMs.</p>

<p>To do a local setup of the demo we must run the <code>up.sh</code> script, be aware that this will take a while:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ./up.sh
Bringing machine <span style="color:#e6db74">&#39;master&#39;</span> up with <span style="color:#e6db74">&#39;libvirt&#39;</span> provider...
Bringing machine <span style="color:#e6db74">&#39;node0&#39;</span> up with <span style="color:#e6db74">&#39;libvirt&#39;</span> provider...
Bringing machine <span style="color:#e6db74">&#39;node1&#39;</span> up with <span style="color:#e6db74">&#39;libvirt&#39;</span> provider...
<span style="color:#f92672">==</span>&gt; master: Checking <span style="color:#66d9ef">if</span> box <span style="color:#e6db74">&#39;centos/7&#39;</span> is up to date...
<span style="color:#f92672">==</span>&gt; node1: Checking <span style="color:#66d9ef">if</span> box <span style="color:#e6db74">&#39;centos/7&#39;</span> is up to date...
<span style="color:#f92672">==</span>&gt; node0: Checking <span style="color:#66d9ef">if</span> box <span style="color:#e6db74">&#39;centos/7&#39;</span> is up to date...

<span style="color:#f92672">[</span> . . . <span style="color:#f92672">]</span>

PLAY RECAP *********************************************************************
master                     : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">35</span>   changed<span style="color:#f92672">=</span><span style="color:#ae81ff">31</span>   unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
node0                      : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">33</span>   changed<span style="color:#f92672">=</span><span style="color:#ae81ff">27</span>   unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
node1                      : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">25</span>   changed<span style="color:#f92672">=</span><span style="color:#ae81ff">23</span>   unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span></code></pre></div>
<p>Remote configuration requires defining our remote libvirt system using <code>LIBVIRT_HOST</code> and <code>LIBVIRT_USER</code> environmental variables before calling the <code>up.sh</code> script.  <code>LIBVIRT_USER</code> defaults to <code>root</code>, so we don&rsquo;t need to set it up if that&rsquo;s what we want to use:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ export LIBVIRT_HOST<span style="color:#f92672">=</span><span style="color:#ae81ff">192</span>.168.1.11
$ ./up.sh
Bringing machine <span style="color:#e6db74">&#39;master&#39;</span> up with <span style="color:#e6db74">&#39;libvirt&#39;</span> provider...
Bringing machine <span style="color:#e6db74">&#39;node0&#39;</span> up with <span style="color:#e6db74">&#39;libvirt&#39;</span> provider...
Bringing machine <span style="color:#e6db74">&#39;node1&#39;</span> up with <span style="color:#e6db74">&#39;libvirt&#39;</span> provider...
<span style="color:#f92672">==</span>&gt; master: Checking <span style="color:#66d9ef">if</span> box <span style="color:#e6db74">&#39;centos/7&#39;</span> is up to date...
<span style="color:#f92672">==</span>&gt; node1: Checking <span style="color:#66d9ef">if</span> box <span style="color:#e6db74">&#39;centos/7&#39;</span> is up to date...
<span style="color:#f92672">==</span>&gt; node0: Checking <span style="color:#66d9ef">if</span> box <span style="color:#e6db74">&#39;centos/7&#39;</span> is up to date...

<span style="color:#f92672">[</span> . . . <span style="color:#f92672">]</span>

PLAY RECAP *********************************************************************
master                     : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">35</span>   changed<span style="color:#f92672">=</span><span style="color:#ae81ff">31</span>   unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
node0                      : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">33</span>   changed<span style="color:#f92672">=</span><span style="color:#ae81ff">27</span>   unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
node1                      : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">25</span>   changed<span style="color:#f92672">=</span><span style="color:#ae81ff">23</span>   unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span></code></pre></div>
<h3 id="usage">Usage</h3>

<p>During the setup the Kubernetes configuration is copied from the master VM to the host, so on completion we can use it locally as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl --kubeconfig<span style="color:#f92672">=</span>kubeconfig.conf get nodes
master    Ready     master    21m       v1.11.1
node0     Ready     &lt;none&gt;    21m       v1.11.1
node1     Ready     &lt;none&gt;    21m       v1.11.1</code></pre></div>
<p>If we don&rsquo;t have <code>kubectl</code> installed in our system we can SSH into the master and run commands from there:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ vagrant ssh master
Last login: Tue Jul <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">10</span>:12:40 <span style="color:#ae81ff">2018</span> from <span style="color:#ae81ff">192</span>.168.121.1
<span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl get nodes
NAME      STATUS    ROLES     AGE       VERSION
master    Ready     master    21m       v1.11.1
node0     Ready     &lt;none&gt;    21m       v1.11.1
node1     Ready     &lt;none&gt;    21m       v1.11.1</code></pre></div>
<p>Unless stated otherwise all the following commands are run assuming we are in the <em>master</em> node.</p>

<p>We can check that the CSI <em>controller</em> service is running:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl get pod csi-controller-0
NAME               READY     STATUS    RESTARTS   AGE
csi-controller-0   <span style="color:#ae81ff">4</span>/4       Running   <span style="color:#ae81ff">0</span>          22m</code></pre></div>
<p>Check the logs of the CSI <em>controller</em>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl logs csi-controller-0 -c csi-driver
Starting Ember CSI v0.0.2 in controller only mode <span style="color:#f92672">(</span>cinderlib: v0.2.2.dev0, cinder: v11.1.1, CSI spec: v0.2.0<span style="color:#f92672">)</span>
Supported filesystems are: cramfs, minix, btrfs, ext2, ext3, ext4, xfs
Running as controller with backend LVMVolumeDriver v3.0.0
Debugging feature is ENABLED with ember_csi.rpdb and OFF. Toggle it with SIGUSR1.
Now serving on unix:///csi-data/csi.sock...
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:28.981718 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">126562384</span><span style="color:#f92672">]</span>: GetPluginInfo without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:28.981747 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">126562384</span><span style="color:#f92672">]</span>: GetPluginInfo returns
        name: <span style="color:#e6db74">&#34;io.ember-csi&#34;</span>
        vendor_version: <span style="color:#e6db74">&#34;0.0.2&#34;</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;cinder-driver&#34;</span>
          value: <span style="color:#e6db74">&#34;LVMVolumeDriver&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;cinder-driver-supported&#34;</span>
          value: <span style="color:#e6db74">&#34;True&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;cinder-driver-version&#34;</span>
          value: <span style="color:#e6db74">&#34;3.0.0&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;cinder-version&#34;</span>
          value: <span style="color:#e6db74">&#34;11.1.1&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;cinderlib-version&#34;</span>
          value: <span style="color:#e6db74">&#34;0.2.2.dev0&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;mode&#34;</span>
          value: <span style="color:#e6db74">&#34;controller&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;persistence&#34;</span>
          value: <span style="color:#e6db74">&#34;CRDPersistence&#34;</span>
        <span style="color:#f92672">}</span>
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:28.984271 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">126562624</span><span style="color:#f92672">]</span>: Probe without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:28.984289 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">126562624</span><span style="color:#f92672">]</span>: Probe returns nothing
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:28.986625 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">126562744</span><span style="color:#f92672">]</span>: GetPluginCapabilities without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:28.986645 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">126562744</span><span style="color:#f92672">]</span>: GetPluginCapabilities returns
        capabilities <span style="color:#f92672">{</span>
          service <span style="color:#f92672">{</span>
            type: CONTROLLER_SERVICE
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:28.988548 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">126562864</span><span style="color:#f92672">]</span>: ControllerGetCapabilities without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:28.988654 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">126562864</span><span style="color:#f92672">]</span>: ControllerGetCapabilities returns
        capabilities <span style="color:#f92672">{</span>
          rpc <span style="color:#f92672">{</span>
            type: CREATE_DELETE_VOLUME
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        capabilities <span style="color:#f92672">{</span>
          rpc <span style="color:#f92672">{</span>
            type: PUBLISH_UNPUBLISH_VOLUME
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        capabilities <span style="color:#f92672">{</span>
          rpc <span style="color:#f92672">{</span>
            type: LIST_VOLUMES
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        capabilities <span style="color:#f92672">{</span>
          rpc <span style="color:#f92672">{</span>
            type: GET_CAPACITY
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span></code></pre></div>
<p>Check that the CSI <em>node</em> services are also running:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl get pod --selector<span style="color:#f92672">=</span>app<span style="color:#f92672">=</span>csi-node
NAME             READY     STATUS    RESTARTS   AGE
csi-node-29sls   <span style="color:#ae81ff">3</span>/3       Running   <span style="color:#ae81ff">0</span>          29m
csi-node-p7r9r   <span style="color:#ae81ff">3</span>/3       Running   <span style="color:#ae81ff">1</span>          29m</code></pre></div>
<p>Check the CSI logs for both <em>node</em> services:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl logs csi-node-29sls -c csi-driver
Starting Ember CSI v0.0.2 in node only mode <span style="color:#f92672">(</span>cinderlib: v0.2.2.dev0, cinder: v11.1.1, CSI spec: v0.2.0<span style="color:#f92672">)</span>
Supported filesystems are: cramfs, minix, btrfs, ext2, ext3, ext4, xfs
Running as node
Debugging feature is ENABLED with ember_csi.rpdb and OFF. Toggle it with SIGUSR1.
Now serving on unix:///csi-data/csi.sock...
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:04.339319 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">123797944</span><span style="color:#f92672">]</span>: GetPluginInfo without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:04.339360 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">123797944</span><span style="color:#f92672">]</span>: GetPluginInfo returns
        name: <span style="color:#e6db74">&#34;io.ember-csi&#34;</span>
        vendor_version: <span style="color:#e6db74">&#34;0.0.2&#34;</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;cinder-version&#34;</span>
          value: <span style="color:#e6db74">&#34;11.1.1&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;cinderlib-version&#34;</span>
          value: <span style="color:#e6db74">&#34;0.2.2.dev0&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;mode&#34;</span>
          value: <span style="color:#e6db74">&#34;node&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;persistence&#34;</span>
          value: <span style="color:#e6db74">&#34;CRDPersistence&#34;</span>
        <span style="color:#f92672">}</span>
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:04.340763 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">123797584</span><span style="color:#f92672">]</span>: NodeGetId without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:04.340781 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">123797584</span><span style="color:#f92672">]</span>: NodeGetId returns
        node_id: <span style="color:#e6db74">&#34;node1&#34;</span>


<span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl logs csi-node-p7r9r -c csi-driver
Starting Ember CSI v0.0.2 in node only mode <span style="color:#f92672">(</span>cinderlib: v0.2.2.dev0, cinder: v11.1.1, CSI spec: v0.2.0<span style="color:#f92672">)</span>
Supported filesystems are: cramfs, minix, btrfs, ext2, ext3, ext4, xfs
Running as node
Debugging feature is ENABLED with ember_csi.rpdb and OFF. Toggle it with SIGUSR1.
Now serving on unix:///csi-data/csi.sock...
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:24.686979 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">126448056</span><span style="color:#f92672">]</span>: GetPluginInfo without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:24.687173 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">126448056</span><span style="color:#f92672">]</span>: GetPluginInfo returns
        name: <span style="color:#e6db74">&#34;io.ember-csi&#34;</span>
        vendor_version: <span style="color:#e6db74">&#34;0.0.2&#34;</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;cinder-version&#34;</span>
          value: <span style="color:#e6db74">&#34;11.1.1&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;cinderlib-version&#34;</span>
          value: <span style="color:#e6db74">&#34;0.2.2.dev0&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;mode&#34;</span>
          value: <span style="color:#e6db74">&#34;node&#34;</span>
        <span style="color:#f92672">}</span>
        manifest <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;persistence&#34;</span>
          value: <span style="color:#e6db74">&#34;CRDPersistence&#34;</span>
        <span style="color:#f92672">}</span>
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:24.691020 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">126447696</span><span style="color:#f92672">]</span>: NodeGetId without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:14:24.691048 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">126447696</span><span style="color:#f92672">]</span>: NodeGetId returns
        node_id: <span style="color:#e6db74">&#34;node0&#34;</span></code></pre></div>
<p>Ember CSI plugin stores connection information in Kubernetes as CRDs when running as a <em>node</em> service. This information is used by the <em>controller</em> Ember service to map the volume to the host curing the connection of a volume to a container.  We can check what information is stored in Kubernetes checking <code>keyvalue</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl get keyvalue
NAME      AGE
node0     30m
node1     30m

<span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl describe kv
Name:         node0
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  value<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;platform&#34;</span>:<span style="color:#e6db74">&#34;x86_64&#34;</span>,<span style="color:#e6db74">&#34;host&#34;</span>:<span style="color:#e6db74">&#34;node0&#34;</span>,<span style="color:#e6db74">&#34;do_local_attach&#34;</span>:false,<span style="color:#e6db74">&#34;ip&#34;</span>:<span style="color:#e6db74">&#34;192.168.10.100&#34;</span>,<span style="color:#e6db74">&#34;os_type&#34;</span>:<span style="color:#e6db74">&#34;linux2&#34;</span>,<span style="color:#e6db74">&#34;multipath&#34;</span>:true,<span style="color:#e6db74">&#34;initiator&#34;</span>:<span style="color:#e6db74">&#34;iqn.1994
</span><span style="color:#e6db74">-05.com.redhat:6cf4bf7fddc0&#34;</span><span style="color:#f92672">}</span>                                                                                                                                  API Version:  ember-csi.io/v1
Kind:         KeyValue
Metadata:
  Creation Timestamp:  <span style="color:#ae81ff">2018</span>-07-24T10:14:16Z
  Generation:          <span style="color:#ae81ff">1</span>
  Resource Version:    <span style="color:#ae81ff">760</span>
  Self Link:           /apis/ember-csi.io/v1/namespaces/default/keyvalues/node0
  UID:                 525d03cf-8f2a-11e8-847c-525400059da0
Events:                &lt;none&gt;


Name:         node1
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  value<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;platform&#34;</span>:<span style="color:#e6db74">&#34;x86_64&#34;</span>,<span style="color:#e6db74">&#34;host&#34;</span>:<span style="color:#e6db74">&#34;node1&#34;</span>,<span style="color:#e6db74">&#34;do_local_attach&#34;</span>:false,<span style="color:#e6db74">&#34;ip&#34;</span>:<span style="color:#e6db74">&#34;192.168.10.101&#34;</span>,<span style="color:#e6db74">&#34;os_type&#34;</span>:<span style="color:#e6db74">&#34;linux2&#34;</span>,<span style="color:#e6db74">&#34;multipath&#34;</span>:true,<span style="color:#e6db74">&#34;initiator&#34;</span>:<span style="color:#e6db74">&#34;iqn.1994
</span><span style="color:#e6db74">-05.com.redhat:1ad738f0b4e&#34;</span><span style="color:#f92672">}</span>                                                                                                                                   API Version:  ember-csi.io/v1
Kind:         KeyValue
Metadata:
  Creation Timestamp:  <span style="color:#ae81ff">2018</span>-07-24T10:14:03Z
  Generation:          <span style="color:#ae81ff">1</span>
  Resource Version:    <span style="color:#ae81ff">735</span>
  Self Link:           /apis/ember-csi.io/v1/namespaces/default/keyvalues/node1
  UID:                 4a4481dc-8f2a-11e8-847c-525400059da0
Events:                &lt;none&gt;</code></pre></div>
<p>Now we can create a 1GB volume using provided PVC manifest:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl create -f kubeyml/pvc.yml
persistentvolumeclaim/csi-pvc created</code></pre></div>
<p>The volume creation will not only result in a new Kubernetes PVC, but also in a new Ember <code>volume</code> CRD with the volume&rsquo;s metadata. We now can check the PVC and the CRD:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl get pvc
NAME      STATUS    VOLUME                 CAPACITY   ACCESS MODES   STORAGECLASS   AGE
csi-pvc   Pending                                                    csi-sc         1s


<span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl get pvc
NAME      STATUS    VOLUME                 CAPACITY   ACCESS MODES   STORAGECLASS   AGE
csi-pvc   Bound     pvc-c24d470e8f2e11e8   1Gi        RWO            csi-sc         25s


<span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl get vol
NAME                                   AGE
4c1b19f4-7336-4d97-b4ab-5ea70efd39d5   1m


<span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl describe vol
Name:         4c1b19f4-7336-4d97-b4ab-5ea70efd39d5
Namespace:    default
Labels:       backend_name<span style="color:#f92672">=</span>lvm
              volume_id<span style="color:#f92672">=</span>4c1b19f4-7336-4d97-b4ab-5ea70efd39d5
              volume_name<span style="color:#f92672">=</span>pvc-c24d470e8f2e11e8
Annotations:  json<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;ovo&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;versioned_object.version&#34;</span>:<span style="color:#e6db74">&#34;1.6&#34;</span>,<span style="color:#e6db74">&#34;versioned_object.name&#34;</span>:<span style="color:#e6db74">&#34;Volume&#34;</span>,<span style="color:#e6db74">&#34;versioned_object.data&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;migration_status&#34;</span>:null,<span style="color:#e6db74">&#34;provider_id&#34;</span>:null,<span style="color:#e6db74">&#34;availability_zone&#34;</span>:<span style="color:#e6db74">&#34;lvm&#34;</span>,<span style="color:#e6db74">&#34;terminated_at&#34;</span>:null,<span style="color:#e6db74">&#34;updat...
</span><span style="color:#e6db74">API Version:  ember-csi.io/v1
</span><span style="color:#e6db74">Kind:         Volume
</span><span style="color:#e6db74">Metadata:
</span><span style="color:#e6db74">  Creation Timestamp:  2018-07-24T10:46:02Z
</span><span style="color:#e6db74">  Generation:          1
</span><span style="color:#e6db74">  Resource Version:    3459
</span><span style="color:#e6db74">  Self Link:           /apis/ember-csi.io/v1/namespaces/default/volumes/4c1b19f4-7336-4d97-b4ab-5ea70efd39d5
</span><span style="color:#e6db74">  UID:                 c2791ec8-8f2e-11e8-847c-525400059da0
</span><span style="color:#e6db74">Events:                &lt;none&gt;</span></code></pre></div>
<p>Each one of the CSI plugin services is running the <code>akrog/csc</code> container with the service&rsquo;s CSI configuration, allowing us to easily send commands directly to that specific CSI plugin using the <a href="https://github.com/rexray/gocsi/tree/master/csc">Container Storage Client</a>.</p>

<p>For example, we can request the CSI <em>controller</em> plugin to list volumes with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl exec -c csc csi-controller-0 csc controller list-volumes
<span style="color:#e6db74">&#34;4c1b19f4-7336-4d97-b4ab-5ea70efd39d5&#34;</span>  <span style="color:#ae81ff">1073741824</span></code></pre></div>
<p>Now we are going to create a container on <em>node1</em>, where neither the CSI <em>controller</em> nor the LVM reside, using the <code>app.yml</code> manifest that mounts the EXT4 PVC we just created into the <code>/data</code> directory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl create -f kubeyml/app.yml
pod/my-csi-app created</code></pre></div>
<p>This process will take some time, as it needs to create the volume, attach it, format it, and mount it.  We can start tailing the CSI <em>controller</em> plugin logs to see that the plugin exports the volume:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl logs csi-controller-0 -fc csi-driver
Starting Ember CSI v0.0.2 in controller only mode <span style="color:#f92672">(</span>cinderlib: v0.2.2.dev0, cinder: v11.1.1, CSI spec: v0.2.0<span style="color:#f92672">)</span>

<span style="color:#f92672">[</span> . . .<span style="color:#f92672">]</span>

<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:54:50.036959 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">126565024</span><span style="color:#f92672">]</span>: ControllerPublishVolume with params
        volume_id: <span style="color:#e6db74">&#34;4c1b19f4-7336-4d97-b4ab-5ea70efd39d5&#34;</span>
        node_id: <span style="color:#e6db74">&#34;node1&#34;</span>
        volume_capability <span style="color:#f92672">{</span>
          mount <span style="color:#f92672">{</span>
            fs_type: <span style="color:#e6db74">&#34;ext4&#34;</span>
          <span style="color:#f92672">}</span>
          access_mode <span style="color:#f92672">{</span>
            mode: SINGLE_NODE_WRITER
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        volume_attributes <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;storage.kubernetes.io/csiProvisionerIdentity&#34;</span>
          value: <span style="color:#e6db74">&#34;1532427201926-8081-io.ember-csi&#34;</span>
        <span style="color:#f92672">}</span>
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:54:51.735242 GRPC in 2s <span style="color:#f92672">[</span><span style="color:#ae81ff">126565024</span><span style="color:#f92672">]</span>: ControllerPublishVolume returns
        publish_info <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;connection_info&#34;</span>
          value: <span style="color:#e6db74">&#34;{\&#34;connector\&#34;: {\&#34;initiator\&#34;: \&#34;iqn.1994-05.com.redhat:1ad738f0b4e\&#34;, \&#34;ip\&#34;: \&#34;192.168.10.101\&#34;, \&#34;platform\&#34;: \&#34;x86_64\&#34;, \&#34;host\&#34;: \&#34;node1\&#34;, \&#34;do_local_attach\&#34;: false, \&#34;os_type\&#34;: \&#34;linux2\&#34;, \&#34;multipath\&#34;: true}, \&#34;conn\&#34;: {\&#34;driver_volume_type\&#34;: \&#34;iscsi\&#34;, \&#34;data\&#34;: {\&#34;target_luns\&#34;: [0], \&#34;target_iqns\&#34;: [\&#34;iqn.2010-10.org.openstack:volume-4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;], \&#34;target_discovered\&#34;: false, \&#34;encrypted\&#34;: false, \&#34;target_iqn\&#34;: \&#34;iqn.2010-10.org.openstack:volume-4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;, \&#34;target_portal\&#34;: \&#34;192.168.10.100:3260\&#34;, \&#34;volume_id\&#34;: \&#34;4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;, \&#34;target_lun\&#34;: 0, \&#34;auth_password\&#34;: \&#34;xtZUGSxeoH7uQ34z\&#34;, \&#34;auth_username\&#34;: \&#34;DcL6r8st8MLzuVBapWhZ\&#34;, \&#34;auth_method\&#34;: \&#34;CHAP\&#34;, \&#34;target_portals\&#34;: [\&#34;192.168.10.100:3260\&#34;]}}}&#34;</span>
        <span style="color:#f92672">}</span>
^C</code></pre></div>
<p>Then, once we see that the <code>ControllerPublishVolume</code> call has completed we go and tail the CSI <em>node</em> plugin logs to see that the plugin attaches the volume to the container:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl logs csi-node-29sls -c csi-driver
Starting Ember CSI v0.0.2 in node only mode <span style="color:#f92672">(</span>cinderlib: v0.2.2.dev0, cinder: v11.1.1, CSI spec: v0.2.0<span style="color:#f92672">)</span>

<span style="color:#f92672">[</span> . . . <span style="color:#f92672">]</span>

<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:54:53.780587 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">123798064</span><span style="color:#f92672">]</span>: NodeGetCapabilities without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:54:53.781102 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">123798064</span><span style="color:#f92672">]</span>: NodeGetCapabilities returns
        capabilities <span style="color:#f92672">{</span>
          rpc <span style="color:#f92672">{</span>
            type: STAGE_UNSTAGE_VOLUME
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:54:53.784211 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">123797944</span><span style="color:#f92672">]</span>: NodeStageVolume with params
        volume_id: <span style="color:#e6db74">&#34;4c1b19f4-7336-4d97-b4ab-5ea70efd39d5&#34;</span>
        publish_info <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;connection_info&#34;</span>
          value: <span style="color:#e6db74">&#34;{\&#34;connector\&#34;: {\&#34;initiator\&#34;: \&#34;iqn.1994-05.com.redhat:1ad738f0b4e\&#34;, \&#34;ip\&#34;: \&#34;192.168.10.101\&#34;, \&#34;platform\&#34;: \&#34;x86_64\&#34;, \&#34;host\&#34;: \&#34;node1\&#34;, \&#34;do_local_attach\&#34;: false, \&#34;os_type\&#34;: \&#34;linux2\&#34;, \&#34;multipath\&#34;: true}, \&#34;conn\&#34;: {\&#34;driver_volume_type\&#34;: \&#34;iscsi\&#34;, \&#34;data\&#34;: {\&#34;target_luns\&#34;: [0], \&#34;target_iqns\&#34;: [\&#34;iqn.2010-10.org.openstack:volume-4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;], \&#34;target_discovered\&#34;: false, \&#34;encrypted\&#34;: false, \&#34;target_iqn\&#34;: \&#34;iqn.2010-10.org.openstack:volume-4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;, \&#34;target_portal\&#34;: \&#34;192.168.10.100:3260\&#34;, \&#34;volume_id\&#34;: \&#34;4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;, \&#34;target_lun\&#34;: 0, \&#34;auth_password\&#34;: \&#34;xtZUGSxeoH7uQ34z\&#34;, \&#34;auth_username\&#34;: \&#34;DcL6r8st8MLzuVBapWhZ\&#34;, \&#34;auth_method\&#34;: \&#34;CHAP\&#34;, \&#34;target_portals\&#34;: [\&#34;192.168.10.100:3260\&#34;]}}}&#34;</span>
        <span style="color:#f92672">}</span>
        staging_target_path: <span style="color:#e6db74">&#34;/var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-c24d470e8f2e11e8/globalmount&#34;</span>
        volume_capability <span style="color:#f92672">{</span>
          mount <span style="color:#f92672">{</span>
          <span style="color:#f92672">}</span>
          access_mode <span style="color:#f92672">{</span>
            mode: SINGLE_NODE_WRITER
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        volume_attributes <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;storage.kubernetes.io/csiProvisionerIdentity&#34;</span>
          value: <span style="color:#e6db74">&#34;1532427201926-8081-io.ember-csi&#34;</span>
        <span style="color:#f92672">}</span>
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:09.380330 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">123799384</span><span style="color:#f92672">]</span>: NodeGetCapabilities without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:09.380891 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">123799384</span><span style="color:#f92672">]</span>: NodeGetCapabilities returns
        capabilities <span style="color:#f92672">{</span>
          rpc <span style="color:#f92672">{</span>
            type: STAGE_UNSTAGE_VOLUME
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:09.383998 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">123798784</span><span style="color:#f92672">]</span>: NodeStageVolume with params
        volume_id: <span style="color:#e6db74">&#34;4c1b19f4-7336-4d97-b4ab-5ea70efd39d5&#34;</span>
        publish_info <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;connection_info&#34;</span>
          value: <span style="color:#e6db74">&#34;{\&#34;connector\&#34;: {\&#34;initiator\&#34;: \&#34;iqn.1994-05.com.redhat:1ad738f0b4e\&#34;, \&#34;ip\&#34;: \&#34;192.168.10.101\&#34;, \&#34;platform\&#34;: \&#34;x86_64\&#34;, \&#34;host\&#34;: \&#34;node1\&#34;, \&#34;do_local_attach\&#34;: false, \&#34;os_type\&#34;: \&#34;linux2\&#34;, \&#34;multipath\&#34;: true}, \&#34;conn\&#34;: {\&#34;driver_volume_type\&#34;: \&#34;iscsi\&#34;, \&#34;data\&#34;: {\&#34;target_luns\&#34;: [0], \&#34;target_iqns\&#34;: [\&#34;iqn.2010-10.org.openstack:volume-4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;], \&#34;target_discovered\&#34;: false, \&#34;encrypted\&#34;: false, \&#34;target_iqn\&#34;: \&#34;iqn.2010-10.org.openstack:volume-4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;, \&#34;target_portal\&#34;: \&#34;192.168.10.100:3260\&#34;, \&#34;volume_id\&#34;: \&#34;4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;, \&#34;target_lun\&#34;: 0, \&#34;auth_password\&#34;: \&#34;xtZUGSxeoH7uQ34z\&#34;, \&#34;auth_username\&#34;: \&#34;DcL6r8st8MLzuVBapWhZ\&#34;, \&#34;auth_method\&#34;: \&#34;CHAP\&#34;, \&#34;target_portals\&#34;: [\&#34;192.168.10.100:3260\&#34;]}}}&#34;</span>
        <span style="color:#f92672">}</span>
        staging_target_path: <span style="color:#e6db74">&#34;/var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-c24d470e8f2e11e8/globalmount&#34;</span>
        volume_capability <span style="color:#f92672">{</span>
          mount <span style="color:#f92672">{</span>
          <span style="color:#f92672">}</span>
          access_mode <span style="color:#f92672">{</span>
            mode: SINGLE_NODE_WRITER
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        volume_attributes <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;storage.kubernetes.io/csiProvisionerIdentity&#34;</span>
          value: <span style="color:#e6db74">&#34;1532427201926-8081-io.ember-csi&#34;</span>
        <span style="color:#f92672">}</span>
Retrying to get a multipathRetrying to get a multipath<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:25.546019 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">124162248</span><span style="color:#f92672">]</span>: NodeGetCapabilities without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:25.546121 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">124162248</span><span style="color:#f92672">]</span>: NodeGetCapabilities returns
        capabilities <span style="color:#f92672">{</span>
          rpc <span style="color:#f92672">{</span>
            type: STAGE_UNSTAGE_VOLUME
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:25.557262 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">123800704</span><span style="color:#f92672">]</span>: NodeStageVolume with params
        volume_id: <span style="color:#e6db74">&#34;4c1b19f4-7336-4d97-b4ab-5ea70efd39d5&#34;</span>
        publish_info <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;connection_info&#34;</span>
          value: <span style="color:#e6db74">&#34;{\&#34;connector\&#34;: {\&#34;initiator\&#34;: \&#34;iqn.1994-05.com.redhat:1ad738f0b4e\&#34;, \&#34;ip\&#34;: \&#34;192.168.10.101\&#34;, \&#34;platform\&#34;: \&#34;x86_64\&#34;, \&#34;host\&#34;: \&#34;node1\&#34;, \&#34;do_local_attach\&#34;: false, \&#34;os_type\&#34;: \&#34;linux2\&#34;, \&#34;multipath\&#34;: true}, \&#34;conn\&#34;: {\&#34;driver_volume_type\&#34;: \&#34;iscsi\&#34;, \&#34;data\&#34;: {\&#34;target_luns\&#34;: [0], \&#34;target_iqns\&#34;: [\&#34;iqn.2010-10.org.openstack:volume-4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;], \&#34;target_discovered\&#34;: false, \&#34;encrypted\&#34;: false, \&#34;target_iqn\&#34;: \&#34;iqn.2010-10.org.openstack:volume-4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;, \&#34;target_portal\&#34;: \&#34;192.168.10.100:3260\&#34;, \&#34;volume_id\&#34;: \&#34;4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;, \&#34;target_lun\&#34;: 0, \&#34;auth_password\&#34;: \&#34;xtZUGSxeoH7uQ34z\&#34;, \&#34;auth_username\&#34;: \&#34;DcL6r8st8MLzuVBapWhZ\&#34;, \&#34;auth_method\&#34;: \&#34;CHAP\&#34;, \&#34;target_portals\&#34;: [\&#34;192.168.10.100:3260\&#34;]}}}&#34;</span>
        <span style="color:#f92672">}</span>
        staging_target_path: <span style="color:#e6db74">&#34;/var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-c24d470e8f2e11e8/globalmount&#34;</span>
        volume_capability <span style="color:#f92672">{</span>
          mount <span style="color:#f92672">{</span>
          <span style="color:#f92672">}</span>
          access_mode <span style="color:#f92672">{</span>
            mode: SINGLE_NODE_WRITER
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        volume_attributes <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;storage.kubernetes.io/csiProvisionerIdentity&#34;</span>
          value: <span style="color:#e6db74">&#34;1532427201926-8081-io.ember-csi&#34;</span>
        <span style="color:#f92672">}</span>
Retrying to get a multipath&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:34.895940 GRPC in 41s <span style="color:#f92672">[</span><span style="color:#ae81ff">123797944</span><span style="color:#f92672">]</span>: NodeStageVolume returns nothing
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:34.900178 GRPC in 26s <span style="color:#f92672">[</span><span style="color:#ae81ff">123798784</span><span style="color:#f92672">]</span>: NodeStageVolume returns nothing
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:34.903827 GRPC in 9s <span style="color:#f92672">[</span><span style="color:#ae81ff">123800704</span><span style="color:#f92672">]</span>: NodeStageVolume returns nothing
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:34.905635 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">123801424</span><span style="color:#f92672">]</span>: NodeGetCapabilities without params
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:34.905701 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">123801424</span><span style="color:#f92672">]</span>: NodeGetCapabilities returns
        capabilities <span style="color:#f92672">{</span>
          rpc <span style="color:#f92672">{</span>
            type: STAGE_UNSTAGE_VOLUME
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
<span style="color:#f92672">=</span>&gt; <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:34.909208 GRPC <span style="color:#f92672">[</span><span style="color:#ae81ff">123800944</span><span style="color:#f92672">]</span>: NodePublishVolume with params
        volume_id: <span style="color:#e6db74">&#34;4c1b19f4-7336-4d97-b4ab-5ea70efd39d5&#34;</span>
        publish_info <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;connection_info&#34;</span>
          value: <span style="color:#e6db74">&#34;{\&#34;connector\&#34;: {\&#34;initiator\&#34;: \&#34;iqn.1994-05.com.redhat:1ad738f0b4e\&#34;, \&#34;ip\&#34;: \&#34;192.168.10.101\&#34;, \&#34;platform\&#34;: \&#34;x86_64\&#34;, \&#34;host\&#34;: \&#34;node1\&#34;, \&#34;do_local_attach\&#34;: false, \&#34;os_type\&#34;: \&#34;linux2\&#34;, \&#34;multipath\&#34;: true}, \&#34;conn\&#34;: {\&#34;driver_volume_type\&#34;: \&#34;iscsi\&#34;, \&#34;data\&#34;: {\&#34;target_luns\&#34;: [0], \&#34;target_iqns\&#34;: [\&#34;iqn.2010-10.org.openstack:volume-4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;], \&#34;target_discovered\&#34;: false, \&#34;encrypted\&#34;: false, \&#34;target_iqn\&#34;: \&#34;iqn.2010-10.org.openstack:volume-4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;, \&#34;target_portal\&#34;: \&#34;192.168.10.100:3260\&#34;, \&#34;volume_id\&#34;: \&#34;4c1b19f4-7336-4d97-b4ab-5ea70efd39d5\&#34;, \&#34;target_lun\&#34;: 0, \&#34;auth_password\&#34;: \&#34;xtZUGSxeoH7uQ34z\&#34;, \&#34;auth_username\&#34;: \&#34;DcL6r8st8MLzuVBapWhZ\&#34;, \&#34;auth_method\&#34;: \&#34;CHAP\&#34;, \&#34;target_portals\&#34;: [\&#34;192.168.10.100:3260\&#34;]}}}&#34;</span>
        <span style="color:#f92672">}</span>
        staging_target_path: <span style="color:#e6db74">&#34;/var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-c24d470e8f2e11e8/globalmount&#34;</span>
        target_path: <span style="color:#e6db74">&#34;/var/lib/kubelet/pods/fca47cf0-8f2f-11e8-847c-525400059da0/volumes/kubernetes.io~csi/pvc-c24d470e8f2e11e8/mount&#34;</span>
        volume_capability <span style="color:#f92672">{</span>
          mount <span style="color:#f92672">{</span>
          <span style="color:#f92672">}</span>
          access_mode <span style="color:#f92672">{</span>
            mode: SINGLE_NODE_WRITER
          <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        volume_attributes <span style="color:#f92672">{</span>
          key: <span style="color:#e6db74">&#34;storage.kubernetes.io/csiProvisionerIdentity&#34;</span>
          value: <span style="color:#e6db74">&#34;1532427201926-8081-io.ember-csi&#34;</span>
        <span style="color:#f92672">}</span>
&lt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2018</span>-07-24 <span style="color:#ae81ff">10</span>:55:34.995042 GRPC in 0s <span style="color:#f92672">[</span><span style="color:#ae81ff">123800944</span><span style="color:#f92672">]</span>: NodePublishVolume returns nothing
^C</code></pre></div>
<p>Now that the volume has been attached to the container we can check that the pod has been successfully created:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl get pod my-csi-app
NAME         READY     STATUS    RESTARTS   AGE
my-csi-app   <span style="color:#ae81ff">1</span>/1       Running   <span style="color:#ae81ff">0</span>          7m</code></pre></div>
<p>When a volume is attached to a container the Ember plugin create a <code>connection</code> CRD that we can check:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl get conn
NAME                                   AGE
b58dceb8-e793-4b11-b5a5-aaf1ca56d9e2   7m


<span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl describe conn
Name:         b58dceb8-e793-4b11-b5a5-aaf1ca56d9e2
Namespace:    default
Labels:       connection_id<span style="color:#f92672">=</span>b58dceb8-e793-4b11-b5a5-aaf1ca56d9e2
              volume_id<span style="color:#f92672">=</span>4c1b19f4-7336-4d97-b4ab-5ea70efd39d5
Annotations:  json<span style="color:#f92672">={</span><span style="color:#e6db74">&#34;ovo&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;versioned_object.version&#34;</span>:<span style="color:#e6db74">&#34;1.2&#34;</span>,<span style="color:#e6db74">&#34;versioned_object.name&#34;</span>:<span style="color:#e6db74">&#34;VolumeAttachment&#34;</span>,<span style="color:#e6db74">&#34;versioned_object.data&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;instance_uuid&#34;</span>:null,<span style="color:#e6db74">&#34;detach_time&#34;</span>:null,<span style="color:#e6db74">&#34;attach_time&#34;</span>:null,<span style="color:#e6db74">&#34;connection_info&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;connect...
</span><span style="color:#e6db74">API Version:  ember-csi.io/v1
</span><span style="color:#e6db74">Kind:         Connection
</span><span style="color:#e6db74">Metadata:
</span><span style="color:#e6db74">  Creation Timestamp:  2018-07-24T10:54:51Z
</span><span style="color:#e6db74">  Generation:          1
</span><span style="color:#e6db74">  Resource Version:    4284
</span><span style="color:#e6db74">  Self Link:           /apis/ember-csi.io/v1/namespaces/default/connections/b58dceb8-e793-4b11-b5a5-aaf1ca56d9e2
</span><span style="color:#e6db74">  UID:                 fdb065e5-8f2f-11e8-847c-525400059da0
</span><span style="color:#e6db74">Events:                &lt;none&gt;</span></code></pre></div>
<p>All the different Ember CRDs, <code>keyvalue</code>, <code>volume</code>, <code>connection</code>, are grouped under the <code>ember</code> name that we can use to get all the Ember-CSI related metadata:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl get ember
NAME      AGE
node0     49m
node1     49m

NAME                                   AGE
4c1b19f4-7336-4d97-b4ab-5ea70efd39d5   17m

NAME                                   AGE
b58dceb8-e793-4b11-b5a5-aaf1ca56d9e2   8m</code></pre></div>
<p>The Ember CSI plugin the demo deploys has the debugging feature enabled, which allows us to get a Python console on GRPC requests.  The debugging is enabled but is turned off at start, and can be toggled using signal <code>USR1</code>.  Once the debug is on we can connect to the Ember CSI container and connect to port 4444.  Toggling debug mode on the controller node is as simple as:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>vagrant@master ~<span style="color:#f92672">]</span>$ kubectl exec csi-controller-0 -c csi-driver -- kill -USR1 <span style="color:#ae81ff">1</span></code></pre></div>
</article>


					
				</div>
			</div>

            
<div id="footer-wrapper">
    <section id="footer" class="container">
        <div class="row">
    <div class="12u">

        
            <div id="copyright">
                &copy; Ember CSI. All rights reserved. Design by geguileo based on <a href="https://curtistimson.co.uk">curttimson</a>'s Hugo port of a <a href="http://html5up.net">HTML5 UP</a> template.  Background image based one from <a href="https://torange.biz/fx/digital-binary-data-futuristic-infographic-background-172436">torange.biz</a>.
            </div>

    </div>
</div>

    </section>
</div>


        </div>

		
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/jquery.dropotron.min.js"></script>
<script src="/assets/js/skel.min.js"></script>
<script src="/assets/js/skel-viewport.min.js"></script>
<script src="/assets/js/util.js"></script>

<script src="/assets/js/main.js"></script>





	</body>
</html>
